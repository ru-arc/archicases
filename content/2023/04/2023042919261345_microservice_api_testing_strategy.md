---
title: "Стратегия тестирования API микросервисов"
date: 2023-04-29T19:26:13+03:00
description: ""
tags: []
ShowToc: true
ShowBreadCrumbs: true
draft: false
---
# Стратегия тестирования API микросервисов
## Описание
Мы сейчас находимся в ситуации распределенного монолита. Тестирование представлено только юнит тестами (включающими обращения к базам) и системное тестирование через UI, в котором прогоняются сквозные сценарии. Все это приводит к тому, что мы не можем независимо выпускать сервисы.
У нас 2 довольно крупных монолита и порядка 40 микросервисов. Большинство из них скорее вспомогательные. Но мы активно делим монолиты, и хочется сделать так, чтобы выделенные куски выпускались независимо.

## Решения
### Решение 1
Тестировать сервис используя АПИ моки (напр. wiremock), написать 80%-90% тестов. Остальное – сквозные интегрционные тесты в окружении, приближенном к боевому. Моки для каждого сервиса создаются авторами этого сервиса.

Плюсы:
- Не нужно поднимать все требуемые сервисы

Минусы:
- Нужно поддерживать моки

### Решение 2
Тестировать сервис используя АПИ моки, 20%-40% тестов. Часть тестов сквозные интегрционные тесты в окружении, приближенном к боевому, часть тестов в реальном окружении.

Плюсы:
- Более "реальное" окружение для тестов

Минусы:
- Необходимо поднимать полное окружение. Нужна хорошая автоматизация для тестового'локального энвайромента

### Решение 3
Использовать различные стратегии для разных сервисов.

> Обычно в продукте можно выделить два-три типа сервисов с разным подходом к тестированию:
> 1) Доменные. Отвечают за логику отдельного субдомена. Зависимостей с другими доменами мало, эти зависимости легко мокаются или заменяются на эмуляторы (эмулятор - это быстрая стандартная заглушка, написанная автором сервиса, нужная для простых и быстрых тестов контрактов). Тестировать лучше как "черный ящик", с подключенной базой данных.
> 2) Интеграционные. Отвечают за междоменную логику, обычно где-то рядом с UI или со сложными сценариями.
     К ним относятся разные bff, реализация сложных междоменных саг и так далее.
     Их реально сложно тестировать на заглушках, проще тестировать на реальном взаимодействии. Но самих таких сервисов мало и функциональности в них должно быть мало.
     Если их тестировать "изолировано" - то полностью на моках.
> 3) Адаптеры. Про взаимодействие с внешними системами.
     Для целей "внутри" легко заменяются на эмулятор или вообще /dev/null (обычно это только исходящие или входящие потоки), при тестировании обычно важно проверять, насколько "внешний мир" соответствует представлениям сервиса о нем. Это как раз про отправку SMS.

## Источники
[Case 7: тестирование микросрвисов](https://t.me/archicases/1345)

## Ссылки
[Статья о тестировании микросервисов](https://agilemindset.ru/тестирование-микросервисов/)
