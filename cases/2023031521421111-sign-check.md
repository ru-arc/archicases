# Организовать работу при периодической недоступности сторонних сервисов
## Описание
Пользователи сервиса N иногда оставляют ЭЦП (усиленную, квалифицированную). Для проверки подлинности этой ЭЦП используется сервис check-sign, который часть проверки осуществляет с помощью сервиса nalog.ru. Схематично взаимодействие представлено ниже:

-   microservice N взаимодействует с check-sign через сообщения в kafka. Топик "check-sign" - запрос на проверку, "success" - успешная проверка, "fail" - неуспешная
-   сервис check-sign для отказоустойчивости развернут в 3 репликах. количество под может быть автоматически увеличено под нагрузкой
-   взаимодействие check-sign и nalog.ru - через REST API, другие способы интеграции отсутствуют
- RPC: 1 000 000 проверок в сутки (предполагается, что на 1 проверку нужен 1 запрос)

Проблемой является периодическая недоступность сервиса nalog.ru. Требуется реализовать возможность накопить сообщения и, когда сервис восстановится, закончить проверку.

## Предложенные решения
### Решение 1
Необработанные подписи складываются в БД. Внешний шедулер периодически вызывает запрос на "переотправку" проблемных подписей.
Проблему с одновременным доступом (concurrent access) на чтение, которую уже захватил другой поток, и использовать конструкцию for update skip locked (или аналогичную), таким образом 2 потока не прочитают одну и ту же запись.

### Решение 2
Необработанные подписи отправляются в топик DLQ. Из этого топика чтение происходит с задержкой и пачками по N записей.

**Минусы**

-   Еще один топик

### Решение 3
Необработанные подписи возвращаются в тот же топик. Чтобы не попасть в бесконечный цикл, на сервисе check-sign необходимо реализовать предохранитель

Минусы
- Придется кодить предохранитель

### Решение 4
Обработка подписей из топика Кафки останавливается, когда сервис nalog.ru недоступен. Когда nalog.ru восстанавливается, обработка подписей продолжается. Прочитанное сообщение не коммитится, пока подпись не будет обработана.  
Если при обработке подписи nalog.ru несколько раз присылает невалидный ответ (но сам сервис доступен), то сообщение коммитится и перезаписывается в конец очереди (чтобы не задерживать обработку сообщений).

**Минусы**
-   Может не сохраняться порядок обработки подписей

## Источники
[GitHub: sign-check-case](https://github.com/froozer/sign-check-case/blob/main/README.md)

[Архитектурные этюды: case#4: sign-check-case](https://t.me/archicases/1111)
